#!/usr/bin/env bash
set -e

usage() {
    cat <<EOF

  ðŸ“¡ READY FOR INSIGHTS â€” Stream CLI
  ----------------------------------
  Usage:
    bin/stream start <event_type>   - Start a producer for a single event type
    bin/stream multi <e1,e2,...>    - Start multiple producers
    bin/stream list                 - List all available event types

EOF
}

stream_start() {
    local event=$1
    local count=${2:-0} # optional arg to control number of messages
    echo "ðŸš€ Starting producer for $event"
    docker compose run --rm producer python main.py --events "$event" --count "$count"
}

stream_multi() {
    IFS=',' read -r -a events <<< "$1"
    for e in "${events[@]}"; do
        stream_start "$e" &
    done
    wait
}

stream_list() {
    echo "ðŸ“œ Available event types:"
    docker compose run --rm producer python main.py --list
}

case "$1" in
    start) stream_start "$2" "$3" ;;
    multi) stream_multi "$2" ;;
    list) stream_list ;;
    *) usage ;;
esac